name: Commit Authorship

on:
  pull_request:
    branches: [main]

jobs:
  authorship-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
          fetch-depth: 0  # Need full history for commit inspection

      - name: Get merge base
        id: merge-base
        run: |
          MERGE_BASE=$(git merge-base HEAD origin/main)
          echo "sha=$MERGE_BASE" >> $GITHUB_OUTPUT

      - name: Check commit authorship
        run: |
          MERGE_BASE="${{ steps.merge-base.outputs.sha }}"
          FAILED=0

          echo "Checking commits since $MERGE_BASE..."
          echo ""

          # Get all commits in this PR
          COMMITS=$(git log --format="%H" "$MERGE_BASE"..HEAD)

          if [ -z "$COMMITS" ]; then
            echo "No commits to check"
            exit 0
          fi

          for COMMIT in $COMMITS; do
            AUTHOR_NAME=$(git log -1 --format="%an" "$COMMIT")
            AUTHOR_EMAIL=$(git log -1 --format="%ae" "$COMMIT")
            COMMIT_MSG=$(git log -1 --format="%B" "$COMMIT")
            SHORT_SHA=$(git log -1 --format="%h" "$COMMIT")

            echo "Checking commit $SHORT_SHA..."

            # Check for forbidden author name
            if [ "$AUTHOR_NAME" = "Claude" ]; then
              echo "ERROR: Commit $SHORT_SHA has forbidden author name 'Claude'"
              FAILED=1
            fi

            # Check for forbidden author email domain
            if echo "$AUTHOR_EMAIL" | grep -q "@anthropic\.com$"; then
              echo "ERROR: Commit $SHORT_SHA has forbidden author email domain '@anthropic.com': $AUTHOR_EMAIL"
              FAILED=1
            fi

            # Check for Co-Authored-By in commit message (case-insensitive)
            if echo "$COMMIT_MSG" | grep -qi "Co-Authored-By:"; then
              echo "ERROR: Commit $SHORT_SHA contains Co-Authored-By statement"
              FAILED=1
            fi
          done

          echo ""
          if [ $FAILED -eq 1 ]; then
            echo "Authorship check failed. Please amend commits to fix the issues above."
            exit 1
          else
            echo "All commits passed authorship check."
          fi
