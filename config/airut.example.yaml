# Airut Server Configuration
#
# Server-side settings: infrastructure, credentials, and operator controls.
# Repo-specific behaviour (git identity, model, timeout, container env,
# network) is in .airut/airut.yaml (loaded from each repo's git mirror).
#
# Copy this file to config/airut.yaml and fill in your values.
# config/airut.yaml is gitignored — never commit real credentials.
#
# Values tagged with !env are resolved from environment variables at load
# time.  Use !env for secrets; put everything else inline.  You can also
# load env vars from a .env file (auto-loaded from repo root).

execution:
  # Maximum number of Claude containers running in parallel (global).
  max_concurrent: 3

  # Seconds to wait for running containers to finish during graceful shutdown.
  shutdown_timeout: 60

  # Conversations with no activity for this many days are garbage-collected.
  conversation_max_age_days: 7

dashboard:
  # Enable the web dashboard for monitoring tasks and viewing actions.
  enabled: true

  # Bind address and port for the dashboard HTTP server.
  host: 127.0.0.1
  port: 5200

  # Public URL used in acknowledgment emails to link to task progress.
  # Leave empty to omit task links from emails.
  base_url: dashboard.example.com

# Container runtime executable (podman or docker).
container_command: podman

# Service LLM — optional Anthropic API key for Airut's internal use.
# Used to generate human-readable error summaries in reply emails.
# This key is NOT passed to containers; it is only used by the gateway
# service itself.
#
# service_llm:
#   api_key: !env AIRUT_SERVICE_LLM_API_KEY
#   model: claude-haiku-4-5  # default; any Anthropic model ID works

# Network settings.
# network:
#   # Upstream DNS server for proxy container resolution.
#   # Auto-detected from /etc/resolv.conf when omitted.
#   upstream_dns: "1.1.1.1"

# ---------------------------------------------------------------------------
# Repositories
# ---------------------------------------------------------------------------
# Each entry under repos: defines a separate email inbox + git repository.
# Every repo gets its own IMAP listener thread, SMTP credentials, authorized
# sender, and secrets pool.  Repos share the global executor pool and
# dashboard.

repos:
  # -------------------------------------------------------------------------
  # Example: primary repository
  # -------------------------------------------------------------------------
  my-project:
    email:
      # IMAP server for receiving emails.
      imap_server: mail.example.com
      imap_port: 993

      # SMTP server for sending reply emails.
      smtp_server: mail.example.com
      smtp_port: 587

      # Email account credentials.  Use !env to keep passwords out of this
      # file — the actual value comes from the environment / .env file.
      username: airut
      password: !env EMAIL_PASSWORD

      # From address for outgoing emails (display name + address).
      from: "Airut <airut@example.com>"

    # Only emails from these addresses/patterns (with passing DMARC) are
    # accepted. Supports wildcards for domain matching (e.g., *@company.com).
    authorized_senders:
      - you@example.com
      # - *@company.com  # Uncomment to allow any sender from company.com

    # The authserv-id to trust in Authentication-Results headers.
    # Typically the hostname of your MX server.
    trusted_authserv_id: mail.example.com

    git:
      # Repository URL cloned into each conversation workspace.
      repo_url: https://github.com/you/my-project.git

    # Root directory for this repo's persistent data: sessions, git mirror.
    storage_dir: ~/airut-storage/my-project

    imap:
      # Seconds between IMAP polls (only used when use_idle is false).
      poll_interval: 30

      # Use IMAP IDLE for efficient push-based notifications (recommended).
      use_idle: true

      # Reconnect interval for IDLE mode in seconds (keep below 29 min).
      idle_reconnect_interval: 1740

    # Named pool of secrets available for this repo to reference via !secret
    # and !secret? tags in .airut/airut.yaml.  Keys are logical names; values
    # are resolved from the environment.
    #
    # Plain secrets are injected directly into the container environment.
    # Use for credentials that don't support header-based auth or need to be
    # used with arbitrary hosts.
    secrets:
      ANTHROPIC_API_KEY: !env ANTHROPIC_API_KEY

    # Server-side network sandbox override.  Both server and repo config
    # default to true; the effective value is the logical AND — if either
    # is false, the sandbox is disabled for this repo.  Useful as a
    # break-glass when a broken allowlist gets checked in.
    #
    # network:
    #   sandbox_enabled: true

    # Masked secrets inject surrogate tokens into containers.  The proxy swaps
    # surrogates for real values only when the request host matches scopes.
    # This prevents credential exfiltration — even if the container is
    # compromised, it only has useless surrogates.
    #
    # Required fields:
    # - value: the secret value (supports !env)
    # - scopes: fnmatch patterns for hosts where replacement is allowed
    # - headers: fnmatch patterns for headers to scan (e.g., "*" for all)
    #
    # Basic Auth is automatically decoded/re-encoded for Authorization headers.
    masked_secrets:
      GH_TOKEN:
        value: !env GH_TOKEN
        scopes:
          - "api.github.com"
          - "*.githubusercontent.com"
        headers:
          - "Authorization"

  # -------------------------------------------------------------------------
  # Example: additional repository (uncomment to use)
  # -------------------------------------------------------------------------
  # another-repo:
  #   email:
  #     imap_server: mail.example.com
  #     smtp_server: mail.example.com
  #     username: airut-other
  #     password: !env OTHER_EMAIL_PASSWORD
  #     from: "Airut <airut-other@example.com>"
  #   authorized_senders:
  #     - you@example.com
  #   trusted_authserv_id: mail.example.com
  #   git:
  #     repo_url: https://github.com/you/another-repo.git
  #   storage_dir: ~/airut-storage/another-repo
  #   secrets:
  #     ANTHROPIC_API_KEY: !env ANTHROPIC_API_KEY
  #     GH_TOKEN: !env GH_TOKEN
